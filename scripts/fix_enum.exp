#!/usr/bin/expect -f
# Fix migration and restart

set timeout 300
set password "Vc8,xn7j_fjdnNGy"

spawn ssh root@158.247.245.197 {
cd /root/auto-dashboard

echo "=== Creating custom init script to handle existing ENUMs ==="
docker compose --env-file .env.production exec -T postgres psql -U trading_user -d trading_db -c "DROP TYPE IF EXISTS positiondirection CASCADE;"
docker compose --env-file .env.production exec -T postgres psql -U trading_user -d trading_db -c "DROP TYPE IF EXISTS bottype CASCADE;"
docker compose --env-file .env.production exec -T postgres psql -U trading_user -d trading_db -c "DROP TYPE IF EXISTS gridmode CASCADE;"
docker compose --env-file .env.production exec -T postgres psql -U trading_user -d trading_db -c "DROP TYPE IF EXISTS gridorderstatus CASCADE;"
docker compose --env-file .env.production exec -T postgres psql -U trading_user -d trading_db -c "DROP TYPE IF EXISTS trenddirection CASCADE;"
docker compose --env-file .env.production exec -T postgres psql -U trading_user -d trading_db -c "DROP TYPE IF EXISTS griddirection CASCADE;"
docker compose --env-file .env.production exec -T postgres psql -U trading_user -d trading_db -c "DROP TABLE IF EXISTS alembic_version CASCADE;"

echo ""
echo "=== Restarting backend to re-run migrations ==="
docker compose --env-file .env.production restart backend

echo ""
echo "=== Waiting 30 seconds ==="
sleep 30

echo ""
echo "=== Container status ==="
docker compose --env-file .env.production ps

echo ""
echo "=== Backend logs (last 30 lines) ==="
docker compose --env-file .env.production logs backend --tail=30

echo ""
echo "=== Creating admin user ==="
docker exec trading-backend python -m src.scripts.create_admin_user 2>&1 || echo "Admin user creation info"
}

expect {
    "*password:*" {
        send "$password\r"
        exp_continue
    }
    eof
}

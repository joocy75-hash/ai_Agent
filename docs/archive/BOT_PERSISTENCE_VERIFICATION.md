# ğŸ¤– ë´‡ ì§€ì†ì„± ê²€ì¦ ë³´ê³ ì„œ

**ê²€ì¦ ì¼ì‹œ**: 2025-12-03
**í•­ëª©**: ë¡œê·¸ì•„ì›ƒ í›„ì—ë„ ë´‡ì´ ê³„ì† ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸

---

## âœ… ê²€ì¦ ê²°ê³¼: ì •ìƒ ì‘ë™

### ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì‚¬ìš©ì ë¸Œë¼ìš°ì €  â”‚
â”‚  (ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTP/WebSocket
         â”‚ (ì—°ê²°ë§Œ ì œê³µ)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ë°±ì—”ë“œ ì„œë²„             â”‚
â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  BotManager      â”‚      â”‚
â”‚  â”‚  â”œâ”€ User 1 ë´‡    â”‚â†â”€â”€â”€â”€â”€â”¼â”€â”€â”€ ë…ë¦½ ì‹¤í–‰
â”‚  â”‚  â”œâ”€ User 2 ë´‡    â”‚      â”‚    (asyncio.Task)
â”‚  â”‚  â””â”€ User 6 ë´‡ âœ… â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â†“                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Database         â”‚      â”‚
â”‚  â”‚  bot_status       â”‚      â”‚
â”‚  â”‚  is_running: 1    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“ (ì£¼ë¬¸ ì‹¤í–‰)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Bitget   â”‚
        â”‚  Exchange  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## í•µì‹¬ êµ¬í˜„

### 1. ì„œë²„ ì‚¬ì´ë“œ ë´‡ ì‹¤í–‰
```python
# backend/src/workers/manager.py
class BotManager:
    def __init__(self, market_queue, session_factory):
        self.runner = BotRunner(market_queue)  # â† ë´‡ì€ ì„œë²„ì—ì„œ ì‹¤í–‰

    async def bootstrap(self):
        # ì„œë²„ ì‹œì‘ ì‹œ DBì—ì„œ is_running=Trueì¸ ë´‡ë“¤ì„ ìë™ ì¬ì‹œì‘
        result = await session.execute(
            select(BotStatus).where(BotStatus.is_running.is_(True))
        )
        for status in result.scalars():
            await self.runner.start(self.session_factory, status.user_id)
```

**ì˜ë¯¸**:
- ë´‡ì€ **ë°±ì—”ë“œ ì„œë²„ í”„ë¡œì„¸ìŠ¤ ë‚´ì—ì„œ** asyncio Taskë¡œ ì‹¤í–‰
- ì‚¬ìš©ìì˜ ë¸Œë¼ìš°ì € ìƒíƒœì™€ **ì™„ì „íˆ ë…ë¦½ì **
- ì„œë²„ê°€ ì‚´ì•„ìˆëŠ” í•œ ê³„ì† ì‹¤í–‰

### 2. ìƒíƒœ ì˜ì†ì„± (DB ì €ì¥)
```python
# backend/src/database/models.py
class BotStatus(Base):
    __tablename__ = "bot_status"

    user_id = Column(Integer, primary_key=True)
    is_running = Column(Boolean, default=False)  # â† í•µì‹¬
    strategy_id = Column(Integer)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
```

**ë´‡ ì‹œì‘ ì‹œ**:
```python
# backend/src/api/bot.py
@router.post("/start")
async def start_bot(request: BotStartRequest, ...):
    # DB ì—…ë°ì´íŠ¸
    bot_status.is_running = True
    await session.commit()

    # ë´‡ ì‹¤í–‰ (ì„œë²„ì—ì„œ)
    await bot_manager.start_bot(user_id)
```

**ë´‡ ì •ì§€ ì‹œ**:
```python
@router.post("/stop")
async def stop_bot(...):
    # DB ì—…ë°ì´íŠ¸
    bot_status.is_running = False
    await session.commit()

    # ë´‡ ì¤‘ì§€
    await bot_manager.stop_bot(user_id)
```

### 3. ì„œë²„ ì¬ì‹œì‘ ì‹œ ìë™ ë³µêµ¬
```python
# backend/src/database/db.py
@asynccontextmanager
async def lifespan(app):
    # ì„œë²„ ì‹œì‘ ì‹œ
    await bot_manager.bootstrap()  # â† ìë™ ì¬ì‹œì‘

    try:
        yield
    finally:
        # ì„œë²„ ì¢…ë£Œ ì‹œ
        # ë´‡ë“¤ì€ graceful shutdown
```

**bootstrap() ë™ì‘**:
1. DBì—ì„œ `is_running=True`ì¸ ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ
2. ê° ì‚¬ìš©ìì˜ ë´‡ì„ ìë™ìœ¼ë¡œ ì¬ì‹œì‘
3. ë¡œê·¸: `Starting bot loop for user {user_id}`

---

## ğŸ§ª ì‹¤ì œ ê²€ì¦

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ë¡œê·¸ì•„ì›ƒ í›„ ë´‡ ìƒíƒœ
```bash
# 1. ë´‡ ì‹œì‘ (ë¡œê·¸ì¸ ìƒíƒœ)
curl -X POST http://localhost:8000/bot/start \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"strategy_id":7}'

# 2. ë´‡ ìƒíƒœ í™•ì¸
sqlite3 trading.db "SELECT user_id, is_running FROM bot_status WHERE user_id=6;"
# ê²°ê³¼: 6|1 âœ…

# 3. ë¡œê·¸ì•„ì›ƒ (ë˜ëŠ” ë¸Œë¼ìš°ì € ë‹«ê¸°)
# â†’ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨

# 4. ë´‡ ì—¬ì „íˆ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
tail -f /tmp/trading_bot.log | grep "Processing market data"
# ê²°ê³¼: ê³„ì† ë¡œê·¸ ì¶œë ¥ë¨ âœ…

# 5. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì—¬ ìƒíƒœ í™•ì¸
curl http://localhost:8000/bot/status \
  -H "Authorization: Bearer $NEW_TOKEN"
# ê²°ê³¼: {"is_running": true, "strategy_id": 7} âœ…
```

#### ì‹œë‚˜ë¦¬ì˜¤ 2: ì„œë²„ ì¬ì‹œì‘ í›„ ë´‡ ë³µêµ¬
```bash
# 1. ë´‡ ì‹¤í–‰ ì¤‘ í™•ì¸
sqlite3 trading.db "SELECT user_id, is_running FROM bot_status;"
# ê²°ê³¼: 6|1

# 2. ì„œë²„ ì¢…ë£Œ
pkill -f uvicorn

# 3. ì„œë²„ ì¬ì‹œì‘
uvicorn src.main:app --host 0.0.0.0 --port 8000

# 4. ë¶€íŠ¸ìŠ¤íŠ¸ë© ë¡œê·¸ í™•ì¸
grep "Starting bot loop" /tmp/trading_bot.log
# ê²°ê³¼: "Starting bot loop for user 6" âœ…

# 5. ë´‡ì´ ìë™ìœ¼ë¡œ ì¬ì‹œì‘ë¨
tail -f /tmp/trading_bot.log | grep "Processing"
# ê²°ê³¼: ì‹œì¥ ë°ì´í„° ì²˜ë¦¬ ì¤‘ âœ…
```

---

## ğŸ“Š í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ë´‡ í™•ì¸

### DB ìƒíƒœ
```sql
sqlite3 trading.db "SELECT * FROM bot_status WHERE user_id = 6;"
```
```
user_id: 6
is_running: 1  âœ…
strategy_id: 7 (Ultra Aggressive Momentum)
```

### ì‹¤ì‹œê°„ ë¡œê·¸ (2025-12-03 17:13)
```
Processing market data: ETHUSDT @ $3057.33
Strategy signal for user 6: buy (confidence: 0.90)
Processing market data: ETHUSDT @ $3057.34
Strategy signal for user 6: buy (confidence: 0.90)
```
**ë´‡ì´ 5ì´ˆë§ˆë‹¤ ê³„ì† ì‹¤í–‰ ì¤‘** âœ…

### í™œì„± í¬ì§€ì…˜
```bash
curl http://localhost:8000/account/positions \
  -H "Authorization: Bearer $TOKEN"
```
```json
{
  "data": [{
    "symbol": "ETH/USDT:USDT",
    "side": "short",
    "amount": 0.02,
    "entry_price": 3056.37,
    "unrealized_pnl": -0.0194
  }]
}
```
**í¬ì§€ì…˜ ê³„ì† ëª¨ë‹ˆí„°ë§ ì¤‘** âœ…

---

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 1. ì„¸ì…˜ vs ë´‡ ì‹¤í–‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì‚¬ìš©ì ì„¸ì…˜ (JWT)          â”‚
â”‚  - ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ          â”‚
â”‚  - ìœ íš¨ê¸°ê°„: 24ì‹œê°„         â”‚
â”‚  - ë´‡ ìƒíƒœ ì¡°íšŒ/ì œì–´ì— ì‚¬ìš©  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†• (API ìš”ì²­ë§Œ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ë´‡ ì‹¤í–‰ ìƒíƒœ (DB)          â”‚
â”‚  - is_running: Boolean     â”‚
â”‚  - ì˜êµ¬ ì €ì¥                â”‚
â”‚  - ì„¸ì…˜ê³¼ ë¬´ê´€í•˜ê²Œ ìœ ì§€      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë¶„ë¦¬ëœ ê´€ì‹¬ì‚¬**:
- **JWT í† í°**: API ì¸ì¦ ë° ê¶Œí•œ í™•ì¸
- **ë´‡ ì‹¤í–‰**: ì„œë²„ í”„ë¡œì„¸ìŠ¤ì—ì„œ ë…ë¦½ ì‹¤í–‰

### 2. ê¶Œí•œ í™•ì¸
```python
# ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë´‡ë§Œ ì œì–´ ê°€ëŠ¥
@router.post("/stop")
async def stop_bot(user: User = Depends(get_current_user)):
    # user.idë¡œë§Œ ìê¸° ë´‡ ì œì–´ ê°€ëŠ¥
    await bot_manager.stop_bot(user.id)
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. ì˜ë„í•˜ì§€ ì•Šì€ ì§€ì† ì‹¤í–‰
```
ì‚¬ìš©ìê°€ "ì •ì§€" ë²„íŠ¼ì„ ëˆ„ë¥´ì§€ ì•Šê³  ê·¸ëƒ¥ ë¡œê·¸ì•„ì›ƒ
â†’ ë´‡ì€ ê³„ì† ì‹¤í–‰ë¨
â†’ í¬ì§€ì…˜ ê³„ì† ê´€ë¦¬ë¨
```

**í•´ê²°**:
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ëª…í™•í•œ UI ì œê³µ
- "ë´‡ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤" ê²½ê³  í‘œì‹œ
- ë¡œê·¸ì•„ì›ƒ ì‹œ ë´‡ ìƒíƒœ ì•Œë¦¼

### 2. ì„œë²„ ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤
```
ì„œë²„ í¬ë˜ì‹œ â†’ ë´‡ ì¤‘ì§€
ì„œë²„ ì¬ì‹œì‘ â†’ ë´‡ ìë™ ì¬ì‹œì‘ (bootstrap)
DBì— is_running=Trueë©´ ê³„ì† ì‹¤í–‰
```

**ê¶Œì¥**:
- í—¬ìŠ¤ ì²´í¬ ëª¨ë‹ˆí„°ë§
- ë´‡ ìƒíƒœ ì•Œë¦¼ (Slack, Email)
- ê¸´ê¸‰ ì •ì§€ ìŠ¤í¬ë¦½íŠ¸

### 3. ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ ë°°í¬
```
Load Balancer
   â†“
[ì„œë²„ 1] [ì„œë²„ 2]
   â†“        â†“
  ë´‡ ì¤‘ë³µ ì‹¤í–‰ ë¬¸ì œ ë°œìƒ âš ï¸
```

**í•´ê²°**:
- Redisë¥¼ ì‚¬ìš©í•œ ë¶„ì‚° ë½
- ë´‡ì€ ë‹¨ì¼ ì„œë²„ì—ì„œë§Œ ì‹¤í–‰
- ë˜ëŠ” Celery/Redisë¥¼ ì‚¬ìš©í•œ ì›Œì»¤ ë¶„ë¦¬

---

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë´‡ ì§€ì†ì„± í™•ì¸
- [x] ì„œë²„ ì‚¬ì´ë“œ ì‹¤í–‰
- [x] DBì— ìƒíƒœ ì €ì¥
- [x] ë¡œê·¸ì•„ì›ƒ í›„ì—ë„ ì‹¤í–‰ ì§€ì†
- [x] ì„œë²„ ì¬ì‹œì‘ ì‹œ ìë™ ë³µêµ¬
- [x] ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„° ì²˜ë¦¬
- [x] í¬ì§€ì…˜ ê³„ì† ëª¨ë‹ˆí„°ë§

### ë°°í¬ ì‹œ ê³ ë ¤ì‚¬í•­
- [ ] í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ ëª¨ë‹ˆí„°ë§
- [ ] ë´‡ ìƒíƒœ ì•Œë¦¼ ì‹œìŠ¤í…œ
- [ ] ê¸´ê¸‰ ì •ì§€ í”„ë¡œì‹œì €
- [ ] ë‹¤ì¤‘ ì„œë²„ ë°°í¬ ì‹œ ë¶„ì‚° ë½
- [ ] ë¡œê·¸ ë¡œí…Œì´ì…˜ (ë´‡ ê³„ì† ì‹¤í–‰ = ë¡œê·¸ ê³„ì† ìŒ“ì„)

---

## ğŸ¯ ê²°ë¡ 

### âœ… ê²€ì¦ ì™„ë£Œ
1. **ë¡œê·¸ì•„ì›ƒê³¼ ë¬´ê´€í•˜ê²Œ ë´‡ ì‘ë™** âœ…
2. **ì„œë²„ ì¬ì‹œì‘ ì‹œ ìë™ ë³µêµ¬** âœ…
3. **DBì— ì˜êµ¬ì ìœ¼ë¡œ ìƒíƒœ ì €ì¥** âœ…
4. **ì‹¤ì œ ê±°ë˜ ê³„ì† ì²˜ë¦¬** âœ…

### ì‘ë™ ë°©ì‹ ìš”ì•½
```
ì‚¬ìš©ì ë¡œê·¸ì¸ â†’ ë´‡ ì‹œì‘ â†’ DB: is_running=1
                    â†“
              [ì„œë²„ì—ì„œ ì‹¤í–‰]
                    â†“
ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ â†’ [ë´‡ ê³„ì† ì‹¤í–‰] âœ…
                    â†“
              ì‹œì¥ ë°ì´í„° ì²˜ë¦¬
                    â†“
              ì£¼ë¬¸ ì‹¤í–‰ ê³„ì†
                    â†“
ì‚¬ìš©ì ë‹¤ì‹œ ë¡œê·¸ì¸ â†’ ë´‡ ìƒíƒœ í™•ì¸ ê°€ëŠ¥ âœ…
```

**í˜„ì¬ ì‹œìŠ¤í…œì€ ì™„ë²½í•˜ê²Œ ì´ ìš”êµ¬ì‚¬í•­ì„ ì¶©ì¡±í•©ë‹ˆë‹¤!**

---

**ì‘ì„±**: 2025-12-03
**ê²€ì¦ì**: Claude Code
**ìƒíƒœ**: âœ… VERIFIED

# ============================================================
# AI Trading Platform - Production Deployment Workflow
# Server: Hetzner deep-server (5.161.112.248)
# Triggers: Push to main branch
# ============================================================
# Security Note: This workflow only uses GitHub Secrets,
# not untrusted user input like github.event.* values
# ============================================================

name: Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:

env:
  DEPLOY_PATH: /root/service_c/ai-trading-platform

jobs:
  # ============================================================
  # Job 1: Build and Test
  # ============================================================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Python syntax check
        run: |
          cd backend
          python -m py_compile src/main.py
          python -m py_compile src/services/bot_runner.py
          python -m py_compile src/strategies/eth_ai_autonomous_40pct_strategy.py
          echo "Python syntax check passed"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Frontend build check
        env:
          VITE_API_URL: https://api.ai-deepsignal.com
        run: |
          cd frontend
          npm run build
          echo "Frontend build check passed"

  # ============================================================
  # Job 2: Deploy to Server
  # ============================================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-test
    # environment: production  # Removed - using repo-level secrets
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.HETZNER_SSH_PRIVATE_KEY }}
          SERVER_IP: ${{ secrets.HETZNER_SERVER_IP }}
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${SERVER_IP}" >> ~/.ssh/known_hosts

      - name: Create .env file
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
          AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          REDIS_PASSWORD=${REDIS_PASSWORD}
          JWT_SECRET=${JWT_SECRET}
          ENCRYPTION_KEY=${ENCRYPTION_KEY}
          VITE_API_URL=${VITE_API_URL}
          CORS_ORIGINS=${CORS_ORIGINS}
          AI_PROVIDER=${AI_PROVIDER}
          GEMINI_API_KEY=${GEMINI_API_KEY}
          DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
          TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
          TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
          ENVIRONMENT=production
          LOG_LEVEL=INFO
          EOF

      - name: Sync code to server
        env:
          SERVER_IP: ${{ secrets.HETZNER_SERVER_IP }}
        run: |
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude 'dist' \
            --exclude 'build' \
            --exclude '.env.local' \
            --exclude 'trading.db' \
            --exclude '.scannerwork' \
            --exclude 'backend/logs/*' \
            -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ./ root@${SERVER_IP}:${DEPLOY_PATH}/

      - name: Copy .env to server
        env:
          SERVER_IP: ${{ secrets.HETZNER_SERVER_IP }}
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            .env root@${SERVER_IP}:${DEPLOY_PATH}/.env

      - name: Deploy services
        env:
          SERVER_IP: ${{ secrets.HETZNER_SERVER_IP }}
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${SERVER_IP} << 'ENDSSH'
          cd /root/service_c/ai-trading-platform

          echo "Starting deployment..."

          # Stop existing containers gracefully
          docker compose -f docker-compose.production.yml down --timeout 30 || true

          # Build with no cache
          docker compose -f docker-compose.production.yml build --no-cache

          # Start services
          docker compose -f docker-compose.production.yml up -d

          # Wait for health checks
          sleep 30

          # Check service status
          docker compose -f docker-compose.production.yml ps

          # Health check
          curl -s http://localhost:8000/health || echo "Backend starting..."

          echo "Deployment complete!"
          ENDSSH

      - name: Verify deployment
        env:
          SERVER_IP: ${{ secrets.HETZNER_SERVER_IP }}
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${SERVER_IP} << 'ENDSSH'
          echo "Container status:"
          docker ps --filter "name=groupc-" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

          echo ""
          echo "Resource usage:"
          docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" $(docker ps -q --filter "name=groupc-") || true
          ENDSSH

  # ============================================================
  # Job 3: Post-deployment verification
  # ============================================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Wait for services to stabilize
        run: sleep 60

      - name: Check API health
        env:
          SERVER_IP: ${{ secrets.HETZNER_SERVER_IP }}
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" "http://${SERVER_IP}:8000/health" || echo "000")
          if [ "$response" = "200" ]; then
            echo "API is healthy (HTTP $response)"
          else
            echo "API returned HTTP $response (may still be starting)"
          fi

      - name: Check Frontend
        env:
          SERVER_IP: ${{ secrets.HETZNER_SERVER_IP }}
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" "http://${SERVER_IP}:3001" || echo "000")
          if [ "$response" = "200" ]; then
            echo "Frontend is accessible (HTTP $response)"
          else
            echo "Frontend returned HTTP $response"
          fi

      - name: Deployment summary
        env:
          SERVER_IP: ${{ secrets.HETZNER_SERVER_IP }}
        run: |
          echo "============================================"
          echo "Deployment Summary"
          echo "============================================"
          echo "Server: ${SERVER_IP}"
          echo "API: http://${SERVER_IP}:8000"
          echo "Frontend: http://${SERVER_IP}:3001"
          echo "Admin: http://${SERVER_IP}:4000"
          echo "============================================"

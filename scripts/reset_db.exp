#!/usr/bin/expect -f
# Reset database and fix configuration

set timeout 300
set password "Vc8,xn7j_fjdnNGy"

spawn ssh root@158.247.245.197 {
cd /root/auto-dashboard

echo "=== Stopping all containers ==="
docker compose --env-file .env.production down -v

echo ""
echo "=== Updating .env.production ==="
cat > .env.production << 'EOF'
# PostgreSQL
POSTGRES_USER=trading_user
POSTGRES_PASSWORD=TradingBot2024!SecurePassword
POSTGRES_DB=trading_db

# Redis
REDIS_PASSWORD=Redis2024!SecurePassword

# Backend Security
ENCRYPTION_KEY=Dz9w_blEMa-tMD5hqK6V7yiaYecQBdsTaO0PJR3ESn8=
JWT_SECRET=super-secret-jwt-key-change-this-in-production-2024

# Database URL for SQLAlchemy
DATABASE_URL=postgresql+asyncpg://trading_user:TradingBot2024!SecurePassword@postgres:5432/trading_db

# Frontend URLs
VITE_API_URL=http://158.247.245.197:8000

# CORS Origins
ALLOWED_ORIGINS=http://158.247.245.197:3000,http://158.247.245.197:4000,http://158.247.245.197

# Logging
LOG_LEVEL=INFO
EOF

cat .env.production

echo ""
echo "=== Starting containers with fresh database ==="
docker compose --env-file .env.production up -d

echo ""
echo "=== Waiting for services to be healthy (30 seconds) ==="
sleep 30

echo ""
echo "=== Container status ==="
docker compose --env-file .env.production ps

echo ""
echo "=== Backend logs (last 30 lines) ==="
docker compose --env-file .env.production logs backend --tail=30

echo ""
echo "=== Creating admin user ==="
docker exec trading-backend python -m src.scripts.create_admin_user 2>&1 || echo "Admin creation command failed or user exists"
}

expect {
    "*password:*" {
        send "$password\r"
        exp_continue
    }
    eof
}

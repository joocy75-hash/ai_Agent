# ============================================================
# AI Trading Platform - Optimized Production Deployment
# Server: Hetzner deep-server (5.161.112.248)
# Optimizations:
#   - Docker BuildKit caching (5Î∂Ñ ‚Üí ~1Î∂Ñ)
#   - Parallel frontend builds
#   - Rollback mechanism on failure
#   - Smart health check with retries
# ============================================================

name: Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild without cache'
        required: false
        default: false
        type: boolean

env:
  DEPLOY_PATH: /root/group_c
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ============================================================
  # Job 1: Build and Test (with caching)
  # ============================================================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Python syntax check
        run: |
          cd backend
          python -m py_compile src/main.py
          python -m py_compile src/services/bot_runner.py
          python -m py_compile src/strategies/eth_ai_fusion_strategy.py
          echo "‚úÖ Python syntax check passed"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Frontend build check
        env:
          VITE_API_URL: https://api.deepsignal.shop
        run: |
          cd frontend
          npm run build
          echo "‚úÖ Frontend build check passed"

  # ============================================================
  # Job 2: Deploy with Caching and Rollback
  # ============================================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.HETZNER_SERVER_IP }}" >> ~/.ssh/known_hosts

      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
          VITE_API_URL=${{ secrets.VITE_API_URL }}
          CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
          AI_PROVIDER=${{ secrets.AI_PROVIDER }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          ENVIRONMENT=production
          LOG_LEVEL=INFO
          EOF

      - name: Sync code to server
        run: |
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude 'dist' \
            --exclude 'build' \
            --exclude '.env.local' \
            --exclude 'trading.db' \
            --exclude '.scannerwork' \
            --exclude 'backend/logs/*' \
            -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ./ root@${{ secrets.HETZNER_SERVER_IP }}:${{ env.DEPLOY_PATH }}/

      - name: Copy .env to server
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            .env root@${{ secrets.HETZNER_SERVER_IP }}:${{ env.DEPLOY_PATH }}/.env

      - name: Deploy with caching and rollback
        id: deploy
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.HETZNER_SERVER_IP }} << 'ENDSSH'
          set -e
          cd /root/group_c

          echo "============================================"
          echo "üöÄ Starting optimized deployment..."
          echo "============================================"

          # Enable BuildKit for faster builds
          export DOCKER_BUILDKIT=1
          export COMPOSE_DOCKER_CLI_BUILD=1

          # Save current state for rollback
          echo "üì¶ Saving current state for potential rollback..."
          docker compose -f docker-compose.production.yml ps -q > /tmp/previous_containers.txt 2>/dev/null || true

          # Tag current images for rollback
          for service in backend frontend admin-frontend; do
            current_image=$(docker compose -f docker-compose.production.yml images -q groupc-${service} 2>/dev/null | head -1)
            if [ -n "$current_image" ]; then
              docker tag $current_image groupc-${service}:rollback 2>/dev/null || true
              echo "  Tagged ${service} for rollback"
            fi
          done

          # Determine build mode
          FORCE_REBUILD="${{ inputs.force_rebuild }}"
          if [ "$FORCE_REBUILD" = "true" ]; then
            echo "‚ö†Ô∏è  Force rebuild requested - building without cache"
            BUILD_FLAGS="--no-cache"
          else
            echo "‚úÖ Using Docker BuildKit cache for faster builds"
            BUILD_FLAGS=""
          fi

          # Build images (parallel where possible)
          echo ""
          echo "üî® Building Docker images..."

          # Build backend first (other services may depend on it)
          docker compose -f docker-compose.production.yml build $BUILD_FLAGS backend

          # Build frontends in parallel
          docker compose -f docker-compose.production.yml build $BUILD_FLAGS frontend admin-frontend &
          wait

          echo "‚úÖ All images built successfully"

          # Graceful shutdown
          echo ""
          echo "‚èπÔ∏è  Stopping existing containers gracefully..."
          docker compose -f docker-compose.production.yml down --timeout 30 || true

          # Start services
          echo ""
          echo "‚ñ∂Ô∏è  Starting services..."
          docker compose -f docker-compose.production.yml up -d

          # Health check with retries
          echo ""
          echo "üè• Running health checks..."
          MAX_RETRIES=6
          RETRY_INTERVAL=10

          for i in $(seq 1 $MAX_RETRIES); do
            echo "  Attempt $i/$MAX_RETRIES..."
            sleep $RETRY_INTERVAL

            # Check backend health
            if curl -sf http://localhost:3200/health > /dev/null 2>&1; then
              echo "‚úÖ Backend is healthy!"

              # Check frontend
              if curl -sf http://localhost:3201 > /dev/null 2>&1; then
                echo "‚úÖ Frontend is accessible!"
                echo ""
                echo "============================================"
                echo "üéâ Deployment successful!"
                echo "============================================"

                # Clean up old images (keep last 2)
                echo ""
                echo "üßπ Cleaning up old images..."
                docker image prune -f --filter "until=24h" || true

                exit 0
              fi
            fi

            if [ $i -eq $MAX_RETRIES ]; then
              echo "‚ùå Health check failed after $MAX_RETRIES attempts"

              # Show logs for debugging
              echo ""
              echo "üìã Backend logs (last 50 lines):"
              docker logs groupc-backend --tail 50 2>&1 || true

              # Suggest rollback
              echo ""
              echo "‚ö†Ô∏è  Consider manual rollback:"
              echo "   docker tag groupc-backend:rollback groupc-backend:latest"
              echo "   docker compose -f docker-compose.production.yml up -d"

              exit 1
            fi
          done
          ENDSSH

      - name: Handle deployment failure
        if: failure()
        run: |
          echo "::error::Deployment failed. Check the logs above for details."
          echo "To manually rollback, SSH to server and run:"
          echo "  cd /root/group_c"
          echo "  docker tag groupc-backend:rollback groupc-backend:latest"
          echo "  docker tag groupc-frontend:rollback groupc-frontend:latest"
          echo "  docker compose -f docker-compose.production.yml up -d"

  # ============================================================
  # Job 3: Post-deployment verification
  # ============================================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Set up SSH for verification
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.HETZNER_SERVER_IP }}" >> ~/.ssh/known_hosts

      - name: Comprehensive health check
        run: |
          echo "============================================"
          echo "üîç Post-deployment Verification"
          echo "============================================"

          # API Health
          API_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://${{ secrets.HETZNER_SERVER_IP }}:3200/health" || echo "000")
          if [ "$API_RESPONSE" = "200" ]; then
            echo "‚úÖ API: Healthy (HTTP $API_RESPONSE)"
          else
            echo "‚ö†Ô∏è  API: HTTP $API_RESPONSE"
          fi

          # Frontend
          FE_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://${{ secrets.HETZNER_SERVER_IP }}:3201" || echo "000")
          if [ "$FE_RESPONSE" = "200" ]; then
            echo "‚úÖ Frontend: Accessible (HTTP $FE_RESPONSE)"
          else
            echo "‚ö†Ô∏è  Frontend: HTTP $FE_RESPONSE"
          fi

          # Admin
          ADMIN_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://${{ secrets.HETZNER_SERVER_IP }}:3202" || echo "000")
          if [ "$ADMIN_RESPONSE" = "200" ]; then
            echo "‚úÖ Admin: Accessible (HTTP $ADMIN_RESPONSE)"
          else
            echo "‚ö†Ô∏è  Admin: HTTP $ADMIN_RESPONSE"
          fi

          # HTTPS endpoints
          echo ""
          echo "üîê HTTPS Endpoints:"
          HTTPS_API=$(curl -s -o /dev/null -w "%{http_code}" "https://api.deepsignal.shop/health" || echo "000")
          echo "  API (HTTPS): HTTP $HTTPS_API"

          HTTPS_FE=$(curl -s -o /dev/null -w "%{http_code}" "https://deepsignal.shop" || echo "000")
          echo "  Frontend (HTTPS): HTTP $HTTPS_FE"

      - name: Container status
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.HETZNER_SERVER_IP }} << 'ENDSSH'
          echo ""
          echo "üìä Container Status:"
          docker ps --filter "name=groupc-" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

          echo ""
          echo "üíæ Resource Usage:"
          docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" $(docker ps -q --filter "name=groupc-") 2>/dev/null || true

          echo ""
          echo "üíø Disk Usage:"
          df -h / | tail -1
          docker system df --format "table {{.Type}}\t{{.Size}}\t{{.Reclaimable}}"
          ENDSSH

      - name: Deployment summary
        run: |
          echo ""
          echo "============================================"
          echo "üìã Deployment Summary"
          echo "============================================"
          echo "Server: ${{ secrets.HETZNER_SERVER_IP }}"
          echo ""
          echo "üåê Public URLs:"
          echo "  - Frontend: https://deepsignal.shop"
          echo "  - API: https://api.deepsignal.shop"
          echo "  - Admin: https://admin.deepsignal.shop"
          echo ""
          echo "üîß Internal URLs:"
          echo "  - API: http://${{ secrets.HETZNER_SERVER_IP }}:3200"
          echo "  - Frontend: http://${{ secrets.HETZNER_SERVER_IP }}:3201"
          echo "  - Admin: http://${{ secrets.HETZNER_SERVER_IP }}:3202"
          echo "============================================"
